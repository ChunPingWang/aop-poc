# Data Model: Contact Management System

**Feature Branch**: `001-contact-management`
**Date**: 2026-01-10

## Overview

本文件定義 Contact Management System 的資料模型，包含 Domain Entities、Value Objects、以及對應的資料庫結構。設計遵循六角形架構原則，Domain Model 與 Persistence Model 分離。

---

## Domain Model

### Entity: Contact (Aggregate Root)

聯絡人實體，系統管理的核心業務對象。

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| id | ContactId | Yes | Generated | 系統產生的唯一識別碼 |
| name | String | Yes | 1-50 chars | 聯絡人姓名 |
| phone | String | Yes | 1-20 chars | 聯絡人電話 |
| address | String | No | Max 200 chars | 聯絡人地址 |
| createdAt | LocalDateTime | Yes | Immutable | 建立時間 |
| updatedAt | LocalDateTime | Yes | Auto-update | 最後更新時間 |

**Validation Rules**:
- `name`: 不可為空或空白，長度 1-50 字元
- `phone`: 不可為空或空白，長度 1-20 字元
- `address`: 可為空，若有值則長度不超過 200 字元

**Behavior**:
```java
public class Contact {
    // Factory method for creation
    public static Contact create(String name, String phone, String address) {
        validate(name, phone, address);
        return new Contact(
            null, // ID generated by persistence
            name.trim(),
            phone.trim(),
            address != null ? address.trim() : null,
            LocalDateTime.now(),
            LocalDateTime.now()
        );
    }

    // Update method with validation
    public void updateInfo(String name, String phone, String address) {
        validate(name, phone, address);
        this.name = name.trim();
        this.phone = phone.trim();
        this.address = address != null ? address.trim() : null;
        this.updatedAt = LocalDateTime.now();
    }

    // Assign ID after persistence
    public Contact withId(ContactId id) {
        return new Contact(id, name, phone, address, createdAt, updatedAt);
    }
}
```

---

### Value Object: ContactId

聯絡人識別碼，確保型別安全。

```java
public record ContactId(Long value) {
    public ContactId {
        Objects.requireNonNull(value, "Contact ID cannot be null");
        if (value <= 0) {
            throw new IllegalArgumentException("Contact ID must be positive");
        }
    }
}
```

---

### Entity: AuditLog

稽核日誌實體，記錄所有 API 操作。

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| id | Long | Yes | Generated | 日誌唯一識別碼 |
| operationTime | LocalDateTime | Yes | Immutable | 操作發生時間 |
| operationType | OperationType | Yes | Enum | CREATE/READ/UPDATE/DELETE |
| apiEndpoint | String | Yes | Max 255 chars | API 端點路徑 |
| httpMethod | String | Yes | Max 10 chars | HTTP 方法 |
| requestBody | String | No | Text | 請求內容（JSON） |
| responseStatus | Integer | Yes | 100-599 | HTTP 回應狀態碼 |
| executionTimeMs | Long | Yes | >= 0 | 執行時間（毫秒） |
| clientIp | String | Yes | Max 45 chars | 用戶端 IP 地址 |
| userAgent | String | No | Max 500 chars | 用戶代理字串 |

**Enum: OperationType**:
```java
public enum OperationType {
    CREATE,
    READ,
    UPDATE,
    DELETE
}
```

**Behavior**:
```java
public class AuditLog {
    // Factory method - AuditLog is immutable after creation
    public static AuditLog record(
            OperationType operationType,
            String apiEndpoint,
            String httpMethod,
            String requestBody,
            int responseStatus,
            long executionTimeMs,
            String clientIp,
            String userAgent) {
        return new AuditLog(
            null,
            LocalDateTime.now(),
            operationType,
            apiEndpoint,
            httpMethod,
            requestBody,
            responseStatus,
            executionTimeMs,
            clientIp,
            userAgent
        );
    }
}
```

---

## Database Schema

### Table: contacts

```sql
CREATE TABLE contacts (
    id              BIGSERIAL PRIMARY KEY,
    name            VARCHAR(50) NOT NULL,
    phone           VARCHAR(20) NOT NULL,
    address         VARCHAR(200),
    created_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Index for potential future search
CREATE INDEX idx_contacts_name ON contacts(name);
```

### Table: audit_logs

```sql
CREATE TABLE audit_logs (
    id                  BIGSERIAL PRIMARY KEY,
    operation_time      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    operation_type      VARCHAR(10) NOT NULL,
    api_endpoint        VARCHAR(255) NOT NULL,
    http_method         VARCHAR(10) NOT NULL,
    request_body        TEXT,
    response_status     INTEGER NOT NULL,
    execution_time_ms   BIGINT NOT NULL,
    client_ip           VARCHAR(45) NOT NULL,
    user_agent          VARCHAR(500)
);

-- Indexes for query performance
CREATE INDEX idx_audit_logs_operation_time ON audit_logs(operation_time);
CREATE INDEX idx_audit_logs_operation_type ON audit_logs(operation_type);
CREATE INDEX idx_audit_logs_api_endpoint ON audit_logs(api_endpoint);
CREATE INDEX idx_audit_logs_client_ip ON audit_logs(client_ip);

-- Composite index for common query patterns
CREATE INDEX idx_audit_logs_time_type ON audit_logs(operation_time, operation_type);
```

---

## Entity Relationships

```
┌─────────────────────────────────────────────────────────────────┐
│                        Domain Model                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│   ┌─────────────────┐                                            │
│   │    Contact      │  (Aggregate Root)                          │
│   │    ─────────    │                                            │
│   │  - id: ContactId│◄─┐                                         │
│   │  - name         │  │                                         │
│   │  - phone        │  │  (Value Object)                         │
│   │  - address      │  │  ┌─────────────────┐                    │
│   │  - createdAt    │  └──│    ContactId    │                    │
│   │  - updatedAt    │     │    ─────────    │                    │
│   └─────────────────┘     │  - value: Long  │                    │
│                           └─────────────────┘                    │
│                                                                   │
│   ┌─────────────────┐                                            │
│   │    AuditLog     │  (Entity - no aggregate, logging only)     │
│   │    ─────────    │                                            │
│   │  - id           │                                            │
│   │  - operationTime│                                            │
│   │  - operationType│──────► OperationType (Enum)                │
│   │  - apiEndpoint  │                                            │
│   │  - httpMethod   │                                            │
│   │  - requestBody  │                                            │
│   │  - responseStatus│                                           │
│   │  - executionTimeMs│                                          │
│   │  - clientIp     │                                            │
│   │  - userAgent    │                                            │
│   └─────────────────┘                                            │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘

Note: Contact and AuditLog are independent entities with no direct relationship.
      AuditLog records API operations on Contact resources indirectly via endpoint.
```

---

## State Transitions

### Contact Lifecycle

```
                    ┌─────────────────────────────────────┐
                    │                                     │
    [Not Exists] ───┴──► [Created] ◄───► [Updated] ───► [Deleted]
                         │               │               │
                         │   updateInfo()│               │
                         └───────────────┘               │
                                                         │
                    State is terminal ◄──────────────────┘
```

**State Transitions**:
1. **Not Exists → Created**: `ContactService.createContact(command)`
2. **Created → Updated**: `ContactService.updateContact(id, command)`
3. **Updated → Updated**: `ContactService.updateContact(id, command)`
4. **Created/Updated → Deleted**: `ContactService.deleteContact(id)`

### AuditLog Lifecycle

```
    [Request Received] ──► [Log Created] ──► [Persisted]
                                │
                                └── (Immutable, no further state changes)
```

AuditLog 為不可變實體，建立後不允許修改或刪除。

---

## Validation Summary

| Entity | Field | Validation Rule |
|--------|-------|-----------------|
| Contact | name | NotBlank, Size(1, 50) |
| Contact | phone | NotBlank, Size(1, 20) |
| Contact | address | Size(max=200) |
| AuditLog | operationType | NotNull, Valid Enum |
| AuditLog | apiEndpoint | NotBlank, Size(max=255) |
| AuditLog | httpMethod | NotBlank, Size(max=10) |
| AuditLog | responseStatus | Range(100, 599) |
| AuditLog | executionTimeMs | Min(0) |
| AuditLog | clientIp | NotBlank, Size(max=45) |

---

## JPA Entity Mapping (Infrastructure Layer)

```java
// ContactJpaEntity.java
@Entity
@Table(name = "contacts")
public class ContactJpaEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, length = 50)
    private String name;

    @Column(nullable = false, length = 20)
    private String phone;

    @Column(length = 200)
    private String address;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
        updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        updatedAt = LocalDateTime.now();
    }
}

// AuditLogJpaEntity.java
@Entity
@Table(name = "audit_logs")
public class AuditLogJpaEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "operation_time", nullable = false, updatable = false)
    private LocalDateTime operationTime;

    @Enumerated(EnumType.STRING)
    @Column(name = "operation_type", nullable = false, length = 10)
    private OperationType operationType;

    @Column(name = "api_endpoint", nullable = false, length = 255)
    private String apiEndpoint;

    @Column(name = "http_method", nullable = false, length = 10)
    private String httpMethod;

    @Column(name = "request_body", columnDefinition = "TEXT")
    private String requestBody;

    @Column(name = "response_status", nullable = false)
    private Integer responseStatus;

    @Column(name = "execution_time_ms", nullable = false)
    private Long executionTimeMs;

    @Column(name = "client_ip", nullable = false, length = 45)
    private String clientIp;

    @Column(name = "user_agent", length = 500)
    private String userAgent;

    @PrePersist
    protected void onCreate() {
        operationTime = LocalDateTime.now();
    }
}
```
